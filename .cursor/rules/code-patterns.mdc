---
description: Go-specific patterns, including Functional Options, Bubble Tea (TUI) conventions, and error handling.
globs:
  - "**/*.go"
alwaysApply: false
---

# Go Coding Patterns & UI Development

## Dependency Injection & Options
- **Functional Options**: Use the pattern `func WithX(...) ClientOption` for configuring `GeminiClient` in `internal/api/options.go`.
- **Interfaces**: Always define and use interfaces for core services to allow mocking in TUI tests.
    - `GeminiClientInterface`
    - `ChatSessionInterface`
    - `HistoryStoreInterface`

## TUI Development (Bubble Tea)
- **Model-View-Update (MVU)**: Follow the Elm architecture strictly in `internal/tui`.
- **State Changes**: Perform long-running tasks (API calls) as `tea.Cmd`. 
- **Example Pattern**:
  ```go
  func (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
      switch msg := msg.(type) {
      case generateMsg: // Custom message for API results
          m.Response = msg.Content
          return m, nil
      }
      // ...
  }
  ```
- Use `internal/tui/components/` for reusable UI elements like loaders or status bars.

## Error Handling Pattern
- **Wrap Errors**: Use `errors.NewGeminiError` to add context and custom error codes.
- **Check Predicates**: Use helper functions like `errors.IsAuth(err)` or `errors.IsRateLimit(err)` instead of string matching.

## Concurrency
- Use context cancellation for API requests, especially when the user interrupts a stream in the TUI.
- The `CookieRotator` and `IdleTimer` in `internal/api` should run in background goroutines managed by the client lifecycle.
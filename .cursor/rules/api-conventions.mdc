---
description: Rules for interacting with the reverse-engineered Gemini Web API and handling its specific RPC format.
globs:
  - "internal/api/**/*.go"
  - "internal/models/**/*.go"
alwaysApply: false
---

# API & Communication Conventions

This project interacts with an undocumented, reverse-engineered API. Precision in request formatting and response parsing is mandatory.

## Request Formatting (`f.req`)
- Gemini Web API uses complex, nested JSON arrays inside a form-encoded `f.req` parameter.
- **DO NOT** use standard JSON structs for the entire request; use the helpers in `internal/api/generate.go` to build the nested arrays.
- Always include the `at` parameter (`SNlM0e` token) in POST requests.

## Response Parsing (GJSON)
- Responses are streaming JSON chunks, not a single valid JSON object.
- **Rule**: Use `github.com/tidwall/gjson` for data extraction.
- Refer to `internal/api/paths.go` for the specific GJSON path indices used to navigate the nested arrays.
- **Marker**: The stream is complete when you encounter the `[["e",...]]` marker.

## Authentication Lifecycle
1. **Init**: Fetch the `SNlM0e` token from `https://gemini.google.com/app`.
2. **Refresh**: If a 401/403 occurs, use `api.RefreshFromBrowser()` to pull fresh cookies from local browser profiles (Chrome, Firefox, etc.).
3. **Rotation**: The `CookieRotator` in `internal/api` periodically refreshes the `1PSIDTS` cookie to prevent session expiry.

## Error Handling
- Use `internal/errors` package.
- **Specific Codes**: 
    - `1037`: Usage limit exceeded (Rate limit).
    - `Error 2`: Manual verification (CAPTCHA) required.
- Capture the raw response body in `GeminiError` when parsing fails to aid debugging.
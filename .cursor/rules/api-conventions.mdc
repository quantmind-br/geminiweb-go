---
description: Rules and conventions for interacting with the external Google Gemini Web API.
globs:
  - "internal/api/**/*.go"
  - "internal/commands/**/*.go"
alwaysApply: false
---

# Gemini API Conventions

This document outlines rules for interacting with the external Google Gemini Web API. All related logic is primarily located in `@internal/api/`.

## Authentication Flow

The authentication flow is complex and must be followed precisely.

1.  **Load Cookies**: The `GeminiClient` loads `__Secure-1PSID` and `__Secure-1PSIDTS` from `~/.geminiweb/cookies.json`.
2.  **Fetch Access Token**: Before making a content request, the client must fetch a dynamic `SNlM0e` access token by making a GET request to `https://gemini.google.com/app`.
3.  **Make Request**: The `SNlM0e` token is sent as a form parameter `at` in the `StreamGenerate` request.
4.  **Handle Auth Failure**: If a request fails with an authentication error, the client's `RefreshFromBrowser()` method should be called to attempt recovery.

## Key Endpoints

- **Content Generation**: `POST https://gemini.google.com/_/BardChatUi/data/assistant.lamda.BardFrontendService/StreamGenerate`
- **File Upload**: `POST https://content-push.googleapis.com/upload`
- **Batch Operations (Gems)**: `POST https://gemini.google.com/_/BardChatUi/data/batchexecute`
- **Cookie Rotation**: `POST https://accounts.google.com/RotateCookies`

## Request & Response Formatting

### StreamGenerate Requests
- **Method**: `POST`
- **Content-Type**: `application/x-www-form-urlencoded`
- **Body**: Must contain two form parameters:
    - `at`: The `SNlM0e` access token.
    - `f.req`: A JSON string payload containing the prompt, conversation context, and other metadata.

### StreamGenerate Responses
- **Format**: The response is a streaming, multi-line JSON body. It is not a single valid JSON object.
- **Parsing**: Use `gjson` to parse individual lines and candidates.
- **End of Stream**: The stream is terminated by a specific JSON array: `[["e", ...]]`. The parser must look for this marker to know when the response is complete.

## File Uploads

File uploads are a two-step process:

1.  Upload the file to `https://content-push.googleapis.com/upload`.
2.  The response will be a plain text resource ID.
3.  Embed this resource ID within the `f.req` payload of the `StreamGenerate` request.

Refer to the `UploadFile` method in `@internal/api/upload.go` for the correct implementation.

## Error Handling

- **Anti-Bot**: Google's anti-bot is aggressive. All requests MUST use the custom TLS client. A `401` or `403` status code often indicates an authentication or fingerprinting issue.
- **Rate Limiting**: The API may return errors for too many requests. The client should handle these gracefully. The most common is error code `1037` (usage limit).
- **API Changes**: The API is unofficial and changes without notice. A key breaking change is documented in `@docs/API_BREAKING_CHANGE_2024-12.md`.
